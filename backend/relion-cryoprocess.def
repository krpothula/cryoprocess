Bootstrap: localimage
From: /shared/apps/relion-cryoprocess.sif

%labels
    Author CryoProcess
    Description RELION 5.0.1 with ModelAngelo, ClassRanker, Blush, DynaMight, Topaz
    Version 2.1

%post
    # =========================================================================
    # Install Python pip and dependencies for RELION Python modules
    # =========================================================================
    apt-get update && apt-get install -y --no-install-recommends \
        python3-pip \
        python3-dev \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Upgrade pip
    python3 -m pip install --upgrade pip setuptools wheel

    # =========================================================================
    # Install PyTorch with CUDA 11.8 support
    # PyTorch 2.1.2 fixes hasattr() compatibility with model_angelo
    # (2.0.x raised AssertionError instead of AttributeError in __getattr__)
    # =========================================================================
    python3 -m pip install --no-cache-dir \
        torch==2.1.2+cu118 \
        torchvision==0.16.2+cu118 \
        --extra-index-url https://download.pytorch.org/whl/cu118

    # =========================================================================
    # Install RELION Python module dependencies (from environment.yml)
    # =========================================================================
    python3 -m pip install --no-cache-dir \
        tqdm==4.65.0 \
        mrcfile==1.4.3 \
        "starfile>=0.5.6" \
        loguru==0.7.0 \
        scikit-learn==1.3.0 \
        matplotlib==3.7.2 \
        biopython==1.81 \
        fastcluster==1.2.6 \
        seaborn==0.12.2 \
        dill==0.3.7 \
        numpy==1.26.1 \
        scipy==1.11.2 \
        typer==0.9.0 \
        "click<8.2.0" \
        pydantic==1.10.18

    # =========================================================================
    # Install ModelAngelo from GitHub
    # =========================================================================
    python3 -m pip install --no-cache-dir \
        "git+https://github.com/3dem/model-angelo"

    # =========================================================================
    # Install other RELION Python tools
    # =========================================================================
    python3 -m pip install --no-cache-dir \
        "git+https://github.com/3dem/relion-classranker" \
        "git+https://github.com/3dem/relion-blush" \
        "git+https://github.com/3dem/DynaMight" \
        "git+https://github.com/3dem/topaz"

    # =========================================================================
    # Fix the RELION Python wrapper scripts to use the correct Python
    # =========================================================================
    PYTHON_PATH=$(which python3)
    echo "Python path: $PYTHON_PATH"

    # Update all relion_python_* scripts to use the correct python executable
    for script in /opt/relion/bin/relion_python_*; do
        if [ -f "$script" ]; then
            sed -i "s|^python_executable=\"\"|python_executable=\"${PYTHON_PATH}\"|" "$script"
            echo "Updated: $script"
        fi
    done

    # =========================================================================
    # Patch PyTorch __getattr__ bug: raises AssertionError instead of
    # AttributeError for unknown attrs, breaking hasattr() in model_angelo.
    # This is the correct fix per Python data model spec.
    # =========================================================================
    TORCH_CUDA_INIT="/usr/local/lib/python3.10/dist-packages/torch/backends/cuda/__init__.py"
    if [ -f "$TORCH_CUDA_INIT" ]; then
        sed -i 's/raise AssertionError("Unknown attribute " + name)/raise AttributeError("Unknown attribute " + name)/g' "$TORCH_CUDA_INIT"
        echo "Patched torch.backends.cuda.__getattr__ AssertionError -> AttributeError"
    fi

    # Verify ModelAngelo is importable (full import chain including gnn.inference)
    python3 -c "from model_angelo.__main__ import main; main()" 2>&1 | head -5 || true
    python3 -c "from model_angelo.gnn.inference import infer; print('ModelAngelo full import: OK')"

    # =========================================================================
    # Clean up (avoid removing system temp files that fakeroot can't access)
    # =========================================================================
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%test
    # Verify key components
    echo "=== Testing RELION ==="
    relion_refine --version

    echo "=== Testing Python ==="
    python3 --version

    echo "=== Testing ModelAngelo ==="
    python3 -c "from model_angelo.gnn.inference import infer; print('ModelAngelo (full import): OK')"

    echo "=== Testing ClassRanker ==="
    python3 -c "import classranker; print('ClassRanker: OK')" 2>/dev/null || echo "ClassRanker: not available as import"

    echo "=== Testing Blush ==="
    python3 -c "import blush; print('Blush: OK')" 2>/dev/null || echo "Blush: not available as import"

    echo "=== Testing PyTorch CUDA ==="
    python3 -c "import torch; print(f'PyTorch {torch.__version__}, CUDA: {torch.cuda.is_available()}')"

    echo "=== All tests passed ==="

%environment
    export TORCH_HOME=/opt/relion/torch_weights
    export LC_ALL=C

%runscript
    exec "$@"
